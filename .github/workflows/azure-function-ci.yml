name: Azure Function CI/CD (LEGACY)

# DEPRECATED: This workflow is for the old Azure Functions architecture
# New deployments should use container-app-cicd.yml

on:
  # Disabled - keeping for reference only
  workflow_dispatch:
    inputs:
      legacy_deploy:
        description: 'Deploy legacy Azure Function (deprecated)'
        required: true
        type: boolean

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
            python-version: '3.12'

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build terprint-menu-downloader package
        working-directory: Terprint.Python.MenuDownloader
        run: |
          python -m build

      - name: Publish package to Azure Artifacts
        if: github.ref == 'refs/heads/main'
        env:
          TWINE_USERNAME: ${{ secrets.AZ_ARTIFACTS_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.AZ_ARTIFACTS_PASSWORD }}
        working-directory: Terprint.Python.MenuDownloader
        run: |
          twine upload --repository-url https://pkgs.dev.azure.com/acidni/Terprint/_packaging/terprint/pypi/upload/ dist/*

      - name: Setup Node (for Azure Functions Core Tools)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Azure Functions Core Tools
        run: |
          npm i -g azure-functions-core-tools@4 --unsafe-perm true

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Azure Function
        working-directory: Terprint.Python.MenuDownloader/azure_function
        run: |
          func azure functionapp publish ${{ secrets.AZURE_FUNCTIONAPP_NAME }} --python

      - name: Health Check - Status
        run: |
          STATUS=$(curl -s "https://${{ secrets.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/status?code=${{ secrets.AZURE_FUNCTION_KEY }}")
          echo "$STATUS"
          echo "$STATUS" | jq -e '.status == "healthy"' || exit 1

      - name: Health Check - Batches
        run: |
          HEALTH=$(curl -s -o /tmp/health.json -w "%{http_code}" "https://${{ secrets.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health/batches?code=${{ secrets.AZURE_FUNCTION_KEY }}")
          echo "HTTP: $HEALTH"
          cat /tmp/health.json
          # Fail if service is unavailable (503) or alert=true
          if [ "$HEALTH" = "503" ]; then exit 1; fi
          jq -e 'has("alert") and (.alert == false)' /tmp/health.json || exit 1
