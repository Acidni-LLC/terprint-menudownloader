name: Container App CI/CD

on:
  push:
    branches: [ master ]
    paths:
      - 'container_app/**'
      - 'src/**'
      - '.github/workflows/container-app-cicd.yml'
  pull_request:
    branches: [ master ]
    paths:
      - 'container_app/**'
      - 'src/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  REGISTRY_LOGIN_SERVER: crterprint.azurecr.io
  CONTAINER_APP_NAME: ca-terprint-menudownloader
  RESOURCE_GROUP: rg-dev-terprint-ca
  IMAGE_NAME: terprint-menudownloader

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.build.outputs.image-tag }}
      image-digest: ${{ steps.build.outputs.digest }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure CLI Login
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          # Parse the JSON credentials
          CLIENT_ID=$(echo $AZURE_CREDENTIALS | jq -r .clientId)
          CLIENT_SECRET=$(echo $AZURE_CREDENTIALS | jq -r .clientSecret)
          TENANT_ID=$(echo $AZURE_CREDENTIALS | jq -r .tenantId)
          SUBSCRIPTION_ID=$(echo $AZURE_CREDENTIALS | jq -r .subscriptionId)
          
          # Login using service principal
          az login --service-principal \
            --username $CLIENT_ID \
            --password $CLIENT_SECRET \
            --tenant $TENANT_ID
          
          # Set subscription
          az account set --subscription $SUBSCRIPTION_ID

      - name: Log in to Azure Container Registry
        run: |
          az acr login --name crterprint

      - name: Extract metadata
        id: meta
        run: |
          # Create tag based on branch and commit
          SHORT_SHA="${GITHUB_SHA:0:8}"
          
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            TAG="latest-${SHORT_SHA}"
          else
            TAG="pr-${{ github.event.number }}-${SHORT_SHA}"
          fi
          
          echo "tags=${{ env.REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${TAG}" >> $GITHUB_OUTPUT
          echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Tag: ${TAG}"

      - name: Build and push container image
        id: build
        run: |
          cd container_app
          
          SHORT_SHA="${{ steps.meta.outputs.short-sha }}"
          
          # Build with build context as parent directory to access src/
          az acr build \
            --registry crterprint \
            --image ${{ env.IMAGE_NAME }}:${SHORT_SHA} \
            --image ${{ env.IMAGE_NAME }}:latest \
            --file Dockerfile \
            ..
          
          # Get the digest
          DIGEST=$(az acr repository show-manifests --name crterprint --repository ${{ env.IMAGE_NAME }} --query "[0].digest" -o tsv)
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "image-tag=${SHORT_SHA}" >> $GITHUB_OUTPUT

  deploy-dev:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: 
      name: dev
      url: https://${{ env.CONTAINER_APP_NAME }}.kindmoss-c6723cbe.eastus2.azurecontainerapps.io
      
    steps:
      - name: Azure CLI Login
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          CLIENT_ID=$(echo $AZURE_CREDENTIALS | jq -r .clientId)
          CLIENT_SECRET=$(echo $AZURE_CREDENTIALS | jq -r .clientSecret)
          TENANT_ID=$(echo $AZURE_CREDENTIALS | jq -r .tenantId)
          SUBSCRIPTION_ID=$(echo $AZURE_CREDENTIALS | jq -r .subscriptionId)
          
          az login --service-principal \
            --username $CLIENT_ID \
            --password $CLIENT_SECRET \
            --tenant $TENANT_ID
          
          az account set --subscription $SUBSCRIPTION_ID

      - name: Deploy to Container App
        run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image-tag }}

      - name: Health Check
        run: |
          # Wait for deployment to complete
          sleep 30
          
          # Check health endpoint
          RESPONSE=$(curl -s -o /tmp/health.json -w "%{http_code}" "https://${{ env.CONTAINER_APP_NAME }}.kindmoss-c6723cbe.eastus2.azurecontainerapps.io/health")
          
          echo "HTTP Status: $RESPONSE"
          if [ -f /tmp/health.json ]; then
            echo "Response:"
            cat /tmp/health.json
          fi
          
          # Expect 200 OK
          if [ "$RESPONSE" != "200" ]; then
            echo "Health check failed with status $RESPONSE"
            exit 1
          fi

      - name: Trigger Integration Tests
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_PAT_TERPRINT_TESTS }}
          repository: Acidni-LLC/terprint-tests
          event-type: post-deploy-tests
          client-payload: |
            {
              "service": "menu-downloader",
              "environment": "dev",
              "image_tag": "${{ needs.build.outputs.image-tag }}",
              "deployment_url": "https://${{ env.CONTAINER_APP_NAME }}.kindmoss-c6723cbe.eastus2.azurecontainerapps.io"
            }

  deploy-prod:
    needs: [build, deploy-dev]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    environment: 
      name: production
      url: https://ca-terprint-menudownloader-prod.kindmoss-c6723cbe.eastus2.azurecontainerapps.io
      
    steps:
      - name: Azure CLI Login
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          CLIENT_ID=$(echo $AZURE_CREDENTIALS | jq -r .clientId)
          CLIENT_SECRET=$(echo $AZURE_CREDENTIALS | jq -r .clientSecret)
          TENANT_ID=$(echo $AZURE_CREDENTIALS | jq -r .tenantId)
          SUBSCRIPTION_ID=$(echo $AZURE_CREDENTIALS | jq -r .subscriptionId)
          
          az login --service-principal \
            --username $CLIENT_ID \
            --password $CLIENT_SECRET \
            --tenant $TENANT_ID
          
          az account set --subscription $SUBSCRIPTION_ID

      - name: Deploy to Production Container App
        run: |
          # Note: Update resource group and app name for production
          az containerapp update \
            --name ca-terprint-menudownloader-prod \
            --resource-group rg-prod-terprint-ca \
            --image ${{ env.REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image-tag }}

      - name: Production Health Check
        run: |
          # Wait for deployment to complete
          sleep 60
          
          # Check health endpoint
          RESPONSE=$(curl -s -o /tmp/health.json -w "%{http_code}" "https://ca-terprint-menudownloader-prod.kindmoss-c6723cbe.eastus2.azurecontainerapps.io/health")
          
          echo "HTTP Status: $RESPONSE"
          if [ -f /tmp/health.json ]; then
            echo "Response:"
            cat /tmp/health.json
          fi
          
          # Expect 200 OK
          if [ "$RESPONSE" != "200" ]; then
            echo "Production health check failed with status $RESPONSE"
            exit 1
          fi
