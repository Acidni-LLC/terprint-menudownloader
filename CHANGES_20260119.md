# Terprint Menu Downloader - Changes Summary

## Date: January 19, 2026

### üéØ Objectives Completed

1. **‚úÖ Batch Creator Integration** - Menu downloads now trigger the Batch Creator service
2. **‚úÖ OpenAPI Specification** - Created complete API spec for APIM import
3. **‚úÖ Documentation Updates** - Updated README with 5-stage pipeline flow
4. **‚úÖ Flowery Downloads** - Fixed Flowery Bearer token, now downloading 16 locations
5. **‚úÖ Stock Index Auto-build** - Automatically rebuilds after batch creation

### üì¶ Changes Made

#### 1. Pipeline Integration (`container_app/main.py`)

**Added Batch Creator Configuration:**
```python
BATCH_CREATOR_URL = "https://ca-terprint-batches.kindmoss-c6723cbe.eastus2.azurecontainerapps.io/api/create-batches"
```

**Added `trigger_batch_creator()` Function:**
- Calls Batch Creator POST `/api/create-batches`
- Passes `trigger_coa=True` to automatically trigger COA Processor
- 600-second timeout (batch creation can take time)

**Updated Pipeline Flow:**
```
Stage 2: Menu Downloads
    ‚Üì
Stage 2.5: Batch Creator (NEW - auto-triggered)
    ‚Üì
Stage 3: COA Processor (auto-triggered by Batch Creator)
    ‚Üì
Stock Index Build
```

**Modified Functions:**
- `scheduled_download_job()` - Now calls `trigger_batch_creator()` instead of `trigger_batch_processor()`
- `/run` endpoint - Updated to use Batch Creator
- Error handling - Attempts batch creation even if download fails (partial data recovery)

#### 2. API Documentation (`openapi.json`)

Created comprehensive OpenAPI 3.0.3 specification with:

**Endpoints Documented:**
- `GET /health` - Health check
- `GET /status` - Service status
- `POST /run` - Manual download trigger
- `GET /api/stock/status` - Stock index metadata
- `GET /api/stock/search` - Search by strain name
- `GET /api/stock/{dispensary}` - Dispensary inventory
- `GET /api/stock/{dispensary}/{batch_id}` - Specific batch lookup
- `POST /api/stock/{dispensary}` - Bulk stock check
- `POST /api/stock/build-index` - Manual index rebuild

**Features:**
- Complete request/response schemas
- Parameter descriptions and examples
- APIM security scheme (Ocp-Apim-Subscription-Key)
- Multiple server URLs (Container App + APIM gateway)

#### 3. Documentation Updates (`README.md`)

**New Architecture Diagram:**
- Visual 5-stage pipeline flow
- Shows data flow from downloads ‚Üí batch creation ‚Üí COA processing ‚Üí stock index
- Includes Azure storage paths

**Updated Information:**
- Pipeline stage descriptions
- APIM integration details
- Reference to `openapi.json`

#### 4. Container Deployment

**Built and Deployed:**
- Image: `crterprint.azurecr.io/terprint-menudownloader:batch-creator-20260119-1654`
- Registry: `crterprint.azurecr.io`
- Container App: `ca-terprint-menudownloader`
- Resource Group: `rg-dev-terprint-ca`

**Verified:**
- Health endpoint: ‚úÖ Responding
- Status endpoint: ‚úÖ Version 2.0.0
- Stock API: ‚úÖ Returning 495 unique strains
- Next scheduled run: 5:00 PM UTC (12:00 PM EST)

### üìä Current System State

**Stock Index Status:**
- Build Date: 2026-01-19 16:46:23 UTC
- Total Items: 1,604
- Unique Strains: 495
- Dispensaries: cookies, curaleaf, muv, trulieve (4)
- Source: `consolidated_batches_20260118.json`

**Missing from Index:**
- **Flowery** - Menus downloaded today (16 locations), will appear after tomorrow's 7 AM batch creation

**Flowery Files Downloaded (2026-01-19):**
```
dispensaries/flowery/2026/01/19/
  - flowery_clearwater_menu_20260119_162720.json (768 KB)
  - flowery_hollywood_menu_20260119_162729.json (640 KB)
  - flowery_homestead_menu_20260119_162740.json (872 KB)
  - flowery_inverness_menu_20260119_162750.json (661 KB)
  - flowery_jacksonville_menu_20260119_162759.json (661 KB)
  - flowery_n._miami_menu_20260119_162808.json (649 KB)
  - flowery_ocala_menu_20260119_162818.json (708 KB)
  - flowery_port_orange_menu_20260119_162828.json (788 KB)
  - flowery_tallahassee_menu_20260119_162837.json (743 KB)
  - (+ 7 more locations)
```

### üîÑ Next Steps

#### Immediate Actions Needed

1. **APIM Configuration** - Import `openapi.json` into APIM
   ```bash
   az apim api import \
     --resource-group rg-dev-terprint-shared \
     --service-name apim-terprint-dev \
     --path /menus \
     --specification-path openapi.json \
     --specification-format OpenApi
   ```

2. **Test Stock Endpoints Through APIM**
   ```bash
   # Get APIM subscription key
   $key = az keyvault secret show --vault-name kv-terprint-dev --name apim-subscription-key --query value -o tsv
   
   # Test stock search
   Invoke-RestMethod -Uri "https://apim-terprint-dev.azure-api.net/menus/api/stock/search?strain=Gelato" `
     -Headers @{"Ocp-Apim-Subscription-Key"=$key}
   ```

3. **Wait for Batch Creator** - Next run at 7:00 AM ET tomorrow
   - Will create `consolidated_batches_20260119.json`
   - Will include Flowery data
   - Stock index will automatically rebuild

#### Future Enhancements

1. **Location-Based Search** (Requested)
   - Add latitude/longitude to store data
   - Add `/api/stock/nearest?lat=X&lng=Y` endpoint
   - Calculate distances from user location
   - Requires store coordinate data collection

2. **Stock Index Optimization**
   - Consider building from raw menus immediately after download
   - Currently waits for batch file (created daily at 7 AM)
   - Could add "quick index" for same-day data

3. **Monitoring**
   - Add Application Insights telemetry for Batch Creator calls
   - Track success/failure rates of pipeline stages
   - Alert on Batch Creator failures

### üìù Files Modified

1. `container_app/main.py` - Batch Creator integration
2. `openapi.json` - NEW - Complete API specification
3. `README.md` - Updated architecture and pipeline flow
4. Container App revision 0000026 deployed

### ‚úÖ Testing Checklist

- [x] Docker image builds successfully
- [x] Image pushed to ACR
- [x] Container App updated to new revision
- [x] Health endpoint responds
- [x] Status endpoint shows correct version
- [x] Stock API status endpoint works
- [x] Stock search endpoint works
- [ ] APIM stock endpoints configured
- [ ] APIM stock endpoints tested
- [ ] Flowery appears in stock index (after tomorrow's batch creation)

### üîó Related Services

| Service | URL | Status |
|---------|-----|--------|
| Menu Downloader | `ca-terprint-menudownloader.kindmoss-c6723cbe.eastus2...` | ‚úÖ Running |
| Batch Creator | `ca-terprint-batches.kindmoss-c6723cbe.eastus2...` | ‚úÖ Running |
| Batch Processor | `ca-terprint-batchprocessor.kindmoss-c6723cbe.eastus2...` | ‚úÖ Running |
| APIM Gateway | `apim-terprint-dev.azure-api.net` | ‚è≥ Needs stock endpoints |
| Storage Account | `stterprintsharedgen2/jsonfiles` | ‚úÖ Storing data |

### üìû Support

For questions or issues:
- Repository: `Acidni-LLC/terprint-menudownloader`
- DevOps: `Acidni/Terprint`
- Documentation: `docs/` folder
